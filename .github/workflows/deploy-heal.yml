name: Auto-Healing MySQL Deployment

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-and-heal:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 1. Build and Start Services using Compose
      - name: Deploy with Compose
        run: |
          echo "Starting App and Database..."
          docker compose up -d --build
          
          echo "Waiting for services to stabilize..."
          sleep 15 

      # 2. Health Check & Auto-Healing Logic
      - name: Health Check and Auto-Heal
        run: |
          echo "Checking Health Endpoint..."
          
          # Try to curl the health endpoint
          STATUS_CODE=$(curl -o /dev/null -s -w "%{http_code}\n" http://localhost:5000/health)
          
          if [ "$STATUS_CODE" == "200" ]; then
            echo "✅ Health Check Passed! Database is connected."
            exit 0
          else
            echo "❌ Health Check FAILED (Status: $STATUS_CODE). Attempting Healing..."
            
            # --- HEALING PROCESS ---
            echo "1. Restarting the Web Container..."
            docker compose restart web
            
            echo "Waiting for restart..."
            sleep 10
            
            # Re-check health
            RETRY_STATUS=$(curl -o /dev/null -s -w "%{http_code}\n" http://localhost:5000/health)
            
            if [ "$RETRY_STATUS" == "200" ]; then
               echo "✅ Healing Successful! App is back online."
               exit 0
            else
               echo "❌ Healing Failed. Rolling back everything..."
               docker compose down
               exit 1
            fi
          fi